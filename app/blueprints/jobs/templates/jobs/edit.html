{% extends "_layouts/base.html" %}
{% from "_partials/forms/controls.html" import text_field, select_field, textarea_field %}

{% block title %}Edit Job #{{ job.id }}{% endblock %}

{% block content %}
<section class="space-y-8">
  <header class="flex flex-wrap items-center gap-4 rounded-2xl border border-slate-800/70 bg-slate-900/70 px-6 py-5 shadow-lg shadow-slate-950/40 ring-1 ring-white/5">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Job Editor</p>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-100">Edit Job #{{ job.id }}</h1>
      <p class="text-sm text-slate-400">
        Created {{ job.created_at or "—" }} • Current status {{ job.status or "Unknown" }}
      </p>
    </div>
    <div class="ml-auto flex flex-wrap items-center gap-3">
      <a
        href="{{ url_for('jobs.detail', job_id=job.id) }}"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
      >
        Cancel
      </a>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border border-transparent bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-white transition hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300"
        data-pending-route
        data-pending-target="/jobs/{{ job.id }}/edit"
      >
        Save Changes
      </button>
    </div>
  </header>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/30">
    <div class="flex flex-wrap items-center gap-3">
      <span class="inline-flex items-center gap-2 rounded-full border border-slate-700/70 bg-slate-800/70 px-3 py-1 text-xs font-semibold text-slate-200">
        Created {{ job.created_at or "—" }}
      </span>
      {% if job.completed_at %}
        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">
          Completed {{ job.completed_at }}
        </span>
      {% endif %}
      {% if job.archived %}
        <span class="inline-flex items-center gap-2 rounded-full border border-rose-500/40 bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-200">
          Archived
        </span>
      {% endif %}
    </div>

    <div class="mt-4 flex flex-wrap gap-3">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-xs font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
        data-pending-route
        data-pending-target="/jobs/{{ job.id }}/archive"
      >
        {% if job.archived %}Unarchive{% else %}Archive{% endif %}
      </button>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-xs font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
        data-pending-route
        data-pending-target="/jobs/{{ job.id }}/complete"
      >
        {% if job.completed_at %}Reopen Job{% else %}Mark Completed{% endif %}
      </button>
      <button
        type="button"
        class="ml-auto inline-flex items-center gap-2 rounded-lg border border-rose-500/40 bg-rose-500/10 px-3 py-1.5 text-xs font-semibold text-rose-200 transition hover:border-rose-500 hover:bg-rose-500/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-300"
        data-pending-route
        data-pending-target="/jobs/{{ job.id }}/delete"
      >
        Delete Job
      </button>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/30">
    <header class="flex items-center justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-300">Photos</h2>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-xs font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
        data-pending-route
        data-pending-target="/jobs/{{ job.id }}/photos/upload"
      >
        Upload
      </button>
    </header>
    {% if not photos %}
      <div class="mt-4 rounded-xl border border-slate-800/60 bg-slate-950/60 p-8 text-center text-sm text-slate-400">
        No photos yet.
      </div>
    {% else %}
      <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
        {% for photo in photos %}
          <figure class="overflow-hidden rounded-xl border border-slate-800/70 bg-slate-950/70">
            <div class="aspect-video bg-slate-800">
              <img
                src="{{ photo.url }}"
                alt="{{ photo.label }}"
                class="h-full w-full object-cover"
              />
            </div>
            <figcaption class="flex items-center justify-between px-3 py-2 text-xs text-slate-300">
              <span>{{ photo.label }}</span>
              <button
                type="button"
                class="rounded border border-rose-500/30 bg-rose-500/10 px-2 py-1 text-[11px] font-semibold text-rose-200 transition hover:border-rose-500 hover:bg-rose-500/20"
                data-pending-route
                data-pending-target="/jobs/{{ job.id }}/photos/remove"
              >
                Remove
              </button>
            </figcaption>
          </figure>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/30">
    <form class="space-y-6" onsubmit="return false;">
      <div class="grid gap-4 md:grid-cols-2">
        {{ text_field("date_in", "Date In", job.date_in or "", type="date") }}
        {{ text_field("due_by", "Due By", job.due or "", type="date") }}
        {{ text_field("contact_name", "Contact Name", job.contact_name or "") }}
        {{ text_field("company", "Company", job.customer or "") }}
        {{ text_field("phone", "Phone", job.phone or "") }}
        {{ text_field("email", "Email", job.email or "", type="email") }}
        {{ text_field("po", "Purchase Order", job.po or "") }}
        {{ select_field("type", "Category", form_options.category, job.type or "") }}
        {{ select_field("priority", "Priority", form_options.priority, job.priority or "") }}
        {{ select_field("blast", "Sandblasting", form_options.blast, job.blast or "") }}
        {{ select_field("prep", "Prep", form_options.prep, job.prep or "") }}
        {{ text_field("color", "Color / Coating", job.color or job.coating or "") }}
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.24em] text-slate-500">
          <span>Department</span>
          <select
            class="w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/40"
            id="department"
            name="department"
          >
            {% for value, label in departments %}
              <option value="{{ value }}" {% if value == job.department %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        {{ text_field("status", "Status", job.status or "") }}
      </div>

      {{ textarea_field("description", "Description", job.description or "", rows=5) }}
      {{ textarea_field("notes", "Internal Notes", job.notes or "", rows=5) }}

      <div class="flex flex-wrap items-center gap-3">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-lg border border-transparent bg-emerald-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300"
          data-pending-route
          data-pending-target="/jobs/{{ job.id }}/edit"
        >
          Save Changes
        </button>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-4 py-2 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
          data-pending-route
          data-pending-target="/jobs/{{ job.id }}/worksheet"
        >
          Generate Work Order
        </button>
      </div>
    </form>
  </section>
</section>
{% endblock %}
