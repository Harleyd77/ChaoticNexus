{% extends "_layouts/base.html" %}
{% from "_partials/forms/controls.html" import text_field, select_field, textarea_field %}

{% block title %}Edit Job #{{ job.id }}{% endblock %}

{% block content %}
<section class="space-y-8">
  <header class="flex flex-wrap items-center gap-4 rounded-2xl border border-slate-800/70 bg-slate-900/70 px-6 py-5 shadow-lg shadow-slate-950/40 ring-1 ring-white/5">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Job Editor</p>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-100">Edit Job #{{ job.id }}</h1>
      <p class="text-sm text-slate-400">
        Created {{ job.created_at or "—" }} • Current status {{ job.status or "Unknown" }}
      </p>
    </div>
    <div class="ml-auto flex flex-wrap items-center gap-3">
      <a
        href="{{ url_for('jobs.detail', job_id=job.id) }}"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
      >
        Cancel
      </a>
      <button
        form="job-edit-form"
        type="submit"
        class="inline-flex items-center gap-2 rounded-lg border border-transparent bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-white transition hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300"
      >
        Save Changes
      </button>
    </div>
  </header>

  {% with messages = get_flashed_messages(category_filter=['error', 'success']) %}
    {% if messages %}
      {% for message in messages %}
        <p class="rounded-lg border border-{{ 'emerald-500/40 bg-emerald-500/10 text-emerald-200' if 'success' in message else 'red-500/40 bg-red-500/10 text-red-200' }} px-4 py-2 text-sm">{{ message }}</p>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form id="job-edit-form" method="post" class="space-y-6 rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/30">
    {% if csrf_token is defined %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    {% endif %}
    <div class="grid gap-6 md:grid-cols-2">
      {{ text_field("contact_name", "Contact Name", value=form_data.contact_name) }}
      {{ text_field("phone", "Phone", value=form_data.phone) }}
      {{ text_field("email", "Email", value=form_data.email, type="email") }}
      {{ text_field("company", "Company", value=job.company or '', disabled=True) }}
      {{ text_field("po", "Purchase Order", value=form_data.po) }}
      <div class="relative">
        {{ select_field("type", "Category", form_options.category, form_data.type, placeholder="Select category") }}
        <button type="button" class="absolute right-2 top-7 text-xs text-slate-400 hover:text-slate-200 underline"
                hx-get="{{ url_for('admin.options_drawer') }}?name=category" hx-target="#drawer-root" hx-swap="innerHTML">Edit</button>
      </div>
      <div class="relative">
        {{ select_field("priority", "Priority", form_options.priority, form_data.priority, placeholder="Select priority") }}
        <button type="button" class="absolute right-2 top-7 text-xs text-slate-400 hover:text-slate-200 underline"
                hx-get="{{ url_for('admin.options_drawer') }}?name=priority" hx-target="#drawer-root" hx-swap="innerHTML">Edit</button>
      </div>
      <div class="relative">
        {{ select_field("blast", "Sandblasting", form_options.blast, form_data.blast, placeholder="Select option") }}
        <button type="button" class="absolute right-2 top-7 text-xs text-slate-400 hover:text-slate-200 underline"
                hx-get="{{ url_for('admin.options_drawer') }}?name=blast" hx-target="#drawer-root" hx-swap="innerHTML">Edit</button>
      </div>
      <div class="relative">
        {{ select_field("prep", "Prep", form_options.prep, form_data.prep, placeholder="Select option") }}
        <button type="button" class="absolute right-2 top-7 text-xs text-slate-400 hover:text-slate-200 underline"
                hx-get="{{ url_for('admin.options_drawer') }}?name=prep" hx-target="#drawer-root" hx-swap="innerHTML">Edit</button>
      </div>
      {{ text_field("color", "Color / Coating", value=form_data.color) }}
      <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.24em] text-slate-500">
        <span>Status</span>
        <select
          class="w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/40"
          id="status"
          name="status"
          required
        >
          <option value="" {% if not form_data.status %}selected{% endif %}>Select status</option>
          {% for option in status_options %}
            <option value="{{ option }}" {% if option == form_data.status %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.24em] text-slate-500">
        <span>Department</span>
        <select
          class="w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/40"
          id="department"
          name="department"
        >
          <option value="" {% if not form_data.department %}selected{% endif %}>Select department</option>
          {% for value, label in departments %}
            <option value="{{ value }}" {% if value == form_data.department %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      {{ text_field("date_in", "Date In", value=form_data.date_in, type="date") }}
      {{ text_field("due_by", "Due By", value=form_data.due_by, type="date") }}
    </div>

    {{ textarea_field("description", "Description", form_data.description, rows=5) }}
    {{ textarea_field("notes", "Internal Notes", form_data.notes, rows=5) }}

    <div class="flex flex-wrap items-center gap-3">
      <button
        type="submit"
        class="inline-flex items-center gap-2 rounded-lg border border-transparent bg-emerald-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300"
      >
        Save Changes
      </button>
      <a
        href="{{ url_for('jobs.detail', job_id=job.id) }}"
        class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-4 py-2 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300"
      >
        Cancel
      </a>
    </div>
  </form>
</section>
{% endblock %}
