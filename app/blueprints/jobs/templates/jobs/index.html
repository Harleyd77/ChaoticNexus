{% extends "_layouts/base.html" %}
{% from "_macros/ui.html" import button_primary, button_secondary, metric_card, search_input, status_badge %}

{% block title %}Jobs{% endblock %}

{% from "_macros/ui.html" import page_header %}

{% block content %}
<section class="space-y-8">
  {% call page_header("Jobs", "Track production progress, assignments, and customer details for every active work order.") %}
    {{ button_primary("New Job", href=url_for('jobs.new_job')) }}
    {{ button_secondary("Export CSV", href=url_for('jobs.export_csv')) }}
  {% endcall %}

  {# Metrics #}
  <dl class="grid gap-4 md:grid-cols-3">
    {{ metric_card("Active Jobs", metrics.active, color="emerald") }}
    {{ metric_card("Due Today", metrics.due_today, color="amber") }}
    {{ metric_card("Awaiting Pickup", metrics.awaiting_pickup, color="sky") }}
  </dl>

    <form class="flex flex-wrap items-center gap-3" role="search" method="get" action="">
      {{ search_input(name="q", placeholder="Search by customer, job id, coating...", value=filters.query) }}
      <label class="flex items-center gap-2 rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 focus-within:border-slate-500 focus-within:ring-2 focus-within:ring-slate-500/40">
        <span class="text-slate-500">Stage</span>
        <select
          class="bg-transparent text-sm text-slate-100 focus:outline-none"
          name="stage"
        >
          <option value="all" {% if filters.stage == "all" %}selected{% endif %}>All</option>
          <option value="prep" {% if filters.stage == "prep" %}selected{% endif %}>In Prep</option>
          <option value="queue" {% if filters.stage == "queue" %}selected{% endif %}>Queued</option>
          <option value="qa" {% if filters.stage == "qa" %}selected{% endif %}>Quality Review</option>
          <option value="completed" {% if filters.stage == "completed" %}selected{% endif %}>Completed</option>
        </select>
      </label>
      <label class="inline-flex items-center gap-2 rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-200">
        <input type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-400" name="show_archived" value="1" {% if filters.show_archived %}checked{% endif %} />
        <span>Show archived</span>
      </label>
    </form>
  </header>

  <section class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-400">Current Jobs</h2>
      <span class="text-xs text-slate-500">Routes marked ‚ÄúSoon‚Äù are pending migration.</span>
    </div>

    <div class="grid gap-4">
      {% for job in jobs %}
        <article class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/30 transition hover:border-slate-600 hover:shadow-slate-950/50">
          <header class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">
                <span>{{ job.company or job.customer }}</span>
                {% if job.po or job.reference %}
                  <span class="ml-2 text-sm font-normal text-slate-400">{{ job.po or job.reference }}</span>
                {% endif %}
              </h3>
              <p class="text-sm text-slate-400">
                Job <span class="font-semibold text-slate-200">#{{ job.id }}</span> ‚Ä¢ {{ job.status or (job.department | default('Unknown') | capitalize) }}
              </p>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs">
              {% if job.photos %}
                <span class="inline-flex items-center gap-1 rounded-full border border-sky-500/30 bg-sky-500/10 px-3 py-1 text-sky-200">
                  <span aria-hidden="true">üì∑</span> Photos
                </span>
              {% endif %}
              <span class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-800/80 px-3 py-1 text-slate-300">
                {% if job.due_by %}
                  Due {{ job.due_by.strftime("%b %d") }}
                {% else %}
                  No due date
                {% endif %}
              </span>
            </div>
          </header>

          <dl class="mt-4 grid gap-3 md:grid-cols-3">
            <div>
              <dt class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">Coating</dt>
              <dd class="mt-1 text-sm font-medium text-slate-200">{{ job.color or '‚Äî' }}</dd>
            </div>
            <div>
              <dt class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">Next Step</dt>
              <dd class="mt-1 text-sm font-medium text-slate-200">{{ job.shop_notes or '‚Äî' }}</dd>
            </div>
            <div>
              <dt class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">Status</dt>
              <dd class="mt-1 text-sm font-medium text-slate-200">{{ job.status or (job.department | default('Unknown') | capitalize) }}</dd>
            </div>
          </dl>

          <p class="mt-4 text-sm leading-6 text-slate-300">
            {{ job.notes or job.description or 'No description available.' }}
          </p>

          <footer class="mt-6 flex flex-wrap items-center gap-3">
            {{ button_primary("View Details", href=url_for('jobs.detail', job_id=job.id)) }}
            {{ button_secondary("Edit Job", href=url_for('jobs.edit', job_id=job.id)) }}
            {{ button_secondary("Add to Batch", href=url_for('sprayer.hitlist')) }}
          </footer>
        </article>
      {% else %}
        <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-8 text-center text-slate-400">
          No jobs match your filters yet.
        </div>
      {% endfor %}
    </div>
  </section>
</section>
{% endblock %}
