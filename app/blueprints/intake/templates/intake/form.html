{% extends "_layouts/base.html" %}

{% block title %}Production Intake Form{% endblock %}

{% block head_styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-range.css') }}">
{% endblock %}

{% block content %}
<section class="space-y-8">
  <header class="flex flex-col gap-4 rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/40 ring-1 ring-white/5">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-100">Production Intake Form</h1>
      <p class="text-sm text-slate-400">Create a new production job order.</p>
    </div>
  </header>

  {% if is_admin %}
  <div class="flex justify-end -mt-4">
    <button id="openEditorBtn"
            type="button"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-3 py-1.5 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700">
      Edit Form
    </button>
  </div>
  {% endif %}

  

  <div class="max-w-4xl">
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
      {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      {% endif %}
      <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg">
        <h2 class="text-lg font-semibold text-slate-100 mb-4">Customer Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="contact_name" class="block text-sm font-medium text-slate-300 mb-2">
              Contact Name
              <span aria-hidden="true" class="text-rose-400 required-indicator hidden" data-required-indicator="contact_name">*</span>
            </label>
            <input type="text" id="contact_name" name="contact_name" required
                   class="w-full max-w-md px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
          </div>
          <div>
            <label for="company" class="block text-sm font-medium text-slate-300 mb-2">
              Company
              <span aria-hidden="true" class="text-rose-400 required-indicator hidden" data-required-indicator="company">*</span>
            </label>
            <input type="text" id="company" name="company" required
                   class="w-full max-w-lg px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
          </div>
          <div>
            <label for="phone" class="block text-sm font-medium text-slate-300 mb-2">Phone</label>
            <input type="tel" id="phone" name="phone"
                   class="w-full max-w-md px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
            <input type="email" id="email" name="email"
                   class="w-full max-w-md px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20" />
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg">
        <h2 class="text-lg font-semibold text-slate-100 mb-4">Job Details</h2>
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Production Window *</label>
              <div class="space-y-2">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/60 px-3 py-1.5 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700" data-toggle-calendar="job">
                  Choose dates
                </button>
                <div class="calendar-range hidden" data-calendar-range data-start-selector="#dateIn" data-end-selector="#dueBy" data-calendar-overlay="job" data-cal-close>
                  <div class="cal-header">
                    <button type="button" class="cal-nav" data-cal-prev>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <div class="cal-title">June 2025</div>
                    <button type="button" class="cal-nav" data-cal-next>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                  </div>
                  <div class="cal-grid">
                    <div class="cal-weekdays">
                      <span>Su</span>
                      <span>Mo</span>
                      <span>Tu</span>
                      <span>We</span>
                      <span>Th</span>
                      <span>Fr</span>
                      <span>Sa</span>
                    </div>
                    <div class="cal-days"></div>
                  </div>
                  <div class="cal-footer">
                    <div class="cal-summary">
                      <span class="cal-summary-range">Select a start date</span>
                    </div>
                  <div class="flex gap-2">
                    <button type="button" data-cal-today>Today +7</button>
                    <button type="button" class="cal-close" data-cal-close>Close</button>
                  </div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label for="dateIn" class="text-xs text-slate-400">Start Date</label>
                    <input type="date" id="dateIn" name="dateIn" required class="w-full px-3 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100" />
                  </div>
                  <div>
                    <label for="dueBy" class="text-xs text-slate-400">Due By</label>
                    <input type="date" id="dueBy" name="dueBy" class="w-full px-3 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100" />
                  </div>
                </div>
              </div>
            </div>
            <div>
              <label for="po" class="block text-sm font-medium text-slate-300 mb-2">PO Number</label>
              <input type="text" id="po" name="po" class="w-full max-w-md px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100" />
            </div>
          </div>
          <div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="relative">
              <label for="category" class="block text-sm font-medium text-slate-300 mb-2">
                Category
                <span aria-hidden="true" class="text-rose-400 required-indicator hidden" data-required-indicator="category">*</span>
              </label>
              <select id="category" name="category" required class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100">
                {% for opt in form_options.category %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="relative">
              <label for="priority" class="block text-sm font-medium text-slate-300 mb-2">
                Priority
                <span aria-hidden="true" class="text-rose-400 required-indicator hidden" data-required-indicator="priority">*</span>
              </label>
              <select id="priority" name="priority" required class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100">
                {% for opt in form_options.priority %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="relative">
              <label for="blast" class="block text-sm font-medium text-slate-300 mb-2">Surface Prep</label>
              <select id="blast" name="blast" class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100">
                {% for opt in form_options.blast %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="relative">
              <label for="prep" class="block text-sm font-medium text-slate-300 mb-2">Prep</label>
              <select id="prep" name="prep" class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100">
                {% for opt in form_options.prep %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div>
            <label for="color" class="block text-sm font-medium text-slate-300 mb-2">Color / Coating</label>
            <input type="text" id="color" name="color" class="w-full max-w-md px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100" />
          </div>
          <div class="relative">
            <label for="color_source" class="block text-sm font-medium text-slate-300 mb-2">Color Source</label>
            <select id="color_source" name="color_source" class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100">
              {% for opt in form_options.color_source %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="description" class="block text-sm font-medium text-slate-300 mb-2">Description *</label>
            <textarea id="description" name="description" required rows="4"
                      class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"></textarea>
          </div>
          <div>
            <label for="notes" class="block text-sm font-medium text-slate-300 mb-2">Additional Notes</label>
            <textarea id="notes" name="notes" rows="3"
                      class="w-full px-4 py-2 bg-slate-950/70 border border-slate-800 rounded-lg text-slate-100 placeholder:text-slate-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"></textarea>
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-6 shadow-lg">
        <h2 class="text-lg font-semibold text-slate-100 mb-4">Attachments</h2>
        <p class="text-sm text-slate-400 mb-2">You can add reference photos or PDFs. Files will be labeled with the job ID and a timestamp.</p>
        <input type="file" name="photos" accept="image/*,application/pdf" multiple class="block w-full text-sm text-slate-200 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-800 file:px-4 file:py-2 file:text-sm file:font-semibold hover:file:bg-slate-700" />
      </div>

      <div class="flex gap-3 justify-end">
        <a href="{{ url_for('dashboard.index') }}"
           class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/70 px-6 py-2 text-sm font-medium text-slate-200 transition hover:border-slate-500 hover:bg-slate-700">
          Cancel
        </a>
        <button type="submit"
                class="inline-flex items-center gap-2 rounded-lg border border-transparent bg-emerald-500 px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-400">
          Submit Job
        </button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/calendar-range.js') }}" defer></script>
<script>
  (function(){
    function qs(sel){ return document.querySelector(sel); }
    function readSelectOptions(id){
      const el = document.getElementById(id); if(!el) return [];
      return Array.from(el.querySelectorAll('option')).map(o => (o.value || o.textContent || '').trim()).filter(Boolean);
    }
    function setTextarea(id, values){
      const ta = document.getElementById(id); if(!ta) return;
      ta.value = (values || []).join('\n');
    }
    function openEditor(){
      const ov = qs('#formEditorOverlay'); const pn = qs('#formEditorPanel');
      if(!ov || !pn) return;
      // Prefill from current selects
      setTextarea('edit-category', readSelectOptions('category'));
      setTextarea('edit-priority', readSelectOptions('priority'));
      setTextarea('edit-blast', readSelectOptions('blast'));
      setTextarea('edit-prep', readSelectOptions('prep'));
      setTextarea('edit-color_source', readSelectOptions('color_source'));
      ov.classList.remove('hidden'); pn.classList.remove('hidden');
    }
    function closeEditor(){
      const ov = qs('#formEditorOverlay'); const pn = qs('#formEditorPanel');
      if(ov) ov.classList.add('hidden'); if(pn) pn.classList.add('hidden');
    }
    async function saveList(name, items, csrf){
      const body = new URLSearchParams();
      if (csrf) body.set('csrf_token', csrf);
      body.set('name', name);
      body.set('items', (items || []).join('\n'));
      const res = await fetch('/admin/options/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      });
      if(!res.ok){ throw new Error('Save failed for ' + name + ' (' + res.status + ')'); }
    }
    function readLines(id){
      const ta = document.getElementById(id); if(!ta) return [];
      return (ta.value || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }
    async function showToast(message, ok){
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.setAttribute('role', 'status');
      toast.className = `fixed right-6 top-6 z-[60] rounded-xl border px-4 py-2 text-sm shadow-lg transition-opacity duration-300 ${ok ? 'border-emerald-500/40 bg-emerald-500/10 text-emerald-100' : 'border-red-500/40 bg-red-500/10 text-red-100'}`;
      document.body.appendChild(toast);
      requestAnimationFrame(() => { toast.style.opacity = '1'; });
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.addEventListener('transitionend', () => toast.remove(), { once: true });
      }, 2800);
    }

    async function saveAll(){
      const token = document.querySelector('input[name="csrf_token"]').value;
      const lists = [
        ['category','edit-category'],
        ['priority','edit-priority'],
        ['blast','edit-blast'],
        ['prep','edit-prep'],
        ['color_source','edit-color_source'],
      ];
      for (const [name, taId] of lists){
        const items = readLines(taId);
        await saveList(name, items, token);
      }
      const msg = document.getElementById('formEditorMsg');
      if (msg){
        msg.textContent = 'Dropdowns updated successfully';
        msg.classList.remove('hidden');
        requestAnimationFrame(() => msg.classList.remove('opacity-0'));
        setTimeout(() => msg.classList.add('opacity-0'), 1800);
        setTimeout(() => {
          msg.classList.add('hidden');
          closeEditor();
          window.location.reload();
        }, 2100);
      } else {
        showToast('Dropdowns updated successfully', true);
        closeEditor();
        setTimeout(() => { window.location.reload(); }, 800);
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('[data-toggle-calendar]').forEach(btn => {
        const key = btn.getAttribute('data-toggle-calendar');
        const target = document.querySelector(`[data-calendar-overlay="${key}"]`);
        if (!target) return;
        btn.addEventListener('click', () => {
          target.classList.toggle('hidden');
        });
        target.addEventListener('calendar-update', () => {
          target.classList.add('hidden');
        });
      });
      const btn = document.getElementById('openEditorBtn');
      if(btn) btn.addEventListener('click', openEditor);
      const closeBtns = document.querySelectorAll('[data-close-form-editor]');
      closeBtns.forEach(b => b.addEventListener('click', closeEditor));
      const saveBtn = document.getElementById('formEditorSave');
      if(saveBtn) saveBtn.addEventListener('click', function(e){
        e.preventDefault();
        saveAll().catch(err => {
          const msg = document.getElementById('formEditorMsg');
          if (msg){
            msg.textContent = err.message || 'Save failed';
            msg.classList.remove('hidden');
            msg.classList.remove('opacity-0');
          }
          showToast(err.message || 'Save failed', false);
        });
      });
      const ov = document.getElementById('formEditorOverlay');
      if(ov) ov.addEventListener('click', closeEditor);
    });
  })();
</script>

<!-- Slide-out Editor -->
<div id="formEditorOverlay" class="hidden fixed inset-0 z-40 bg-slate-950/60"></div>
<aside id="formEditorPanel" class="hidden fixed right-0 top-0 z-50 flex h-full w-full max-w-md flex-col bg-slate-900 border-l border-slate-800 shadow-2xl">
  <div class="flex items-center justify-between border-b border-slate-800 p-4">
    <h3 class="text-lg font-semibold text-slate-100">Edit Dropdowns</h3>
    <button type="button" class="text-slate-400 hover:text-slate-200" data-close-form-editor>✕</button>
  </div>
  <div class="flex-1 overflow-y-auto p-4">
    <div class="space-y-4 text-sm">
      <div>
        <label class="mb-2 block text-slate-300">Category (one per line)</label>
        <textarea id="edit-category" class="h-28 w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-slate-100"></textarea>
      </div>
      <div>
        <label class="mb-2 block text-slate-300">Priority (one per line)</label>
        <textarea id="edit-priority" class="h-28 w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-slate-100"></textarea>
      </div>
      <div>
        <label class="mb-2 block text-slate-300">Surface Prep (blast) (one per line)</label>
        <textarea id="edit-blast" class="h-28 w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-slate-100"></textarea>
      </div>
      <div>
        <label class="mb-2 block text-slate-300">Prep (one per line)</label>
        <textarea id="edit-prep" class="h-28 w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-slate-100"></textarea>
      </div>
      <div>
        <label class="mb-2 block text-slate-300">Color Source (one per line)</label>
        <textarea id="edit-color_source" class="h-28 w-full rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-slate-100"></textarea>
      </div>
    </div>
  </div>
  <div class="border-t border-slate-800 bg-slate-900/80 p-4">
    <p id="formEditorMsg" class="pointer-events-none hidden overflow-hidden text-sm text-emerald-200 opacity-0 transition-opacity duration-300"></p>
    <div class="mt-3 flex justify-end gap-3">
      <button type="button" class="rounded-lg px-4 py-2 bg-slate-800 hover:bg-slate-700" data-close-form-editor>Close</button>
      <button id="formEditorSave" type="button" class="rounded-lg px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white">Save</button>
    </div>
  </div>
</aside>
{% endblock %}

