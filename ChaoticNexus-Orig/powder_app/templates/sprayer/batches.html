{% extends "base.html" %}

{% block extra_head %}
<style>
    :root {
      --bg: #0b0f14;
      --panel: #121826;
      --panel-2: #0f1623;
      --card: #1a2333;
      --text: #e6eef7;
      --muted: #9fb3c8;
      --border: #20304a;
      --accent: #4cc9f0;
      --radius: 16px;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, var(--panel-2), var(--bg));
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      background: #0f1623cc;
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #1f2a3b;
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .btn {
      border: 1px solid var(--border);
      background: #0f1726;
      color: #d9e7ff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
    }
    .btn:hover {
      border-color: var(--accent);
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px;
    }
    .card {
      background: #121826;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .mini {
      color: var(--muted);
      font-size: 12px;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .job-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .card-header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: start;
    }
    .job-title {
      font-weight: 600;
    }
    .details {
      display: none;
      margin-top: 8px;
      color: var(--muted);
    }
    .job-card[aria-expanded="true"] .details {
      display: block;
    }
    .job-card.is-collapsible {
      cursor: pointer;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <title>{{ super() }} | Sprayer Batches</title>
<script>
    (function () {
      try {
        var match = document.cookie.match(/(?:^|; )vpc_theme=([^;]+)/);
        var theme = (match ? decodeURIComponent(match[1]) : null) || localStorage.getItem('vpc_theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.style.backgroundColor = theme === 'dark' ? '#0e141b' : '#f7f9fc';
      } catch (err) {}
    })();
  </script>
<script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
<script>
    async function loadCandidates(powderId) {
      const host = document.getElementById('candidateList');
      if (!host) return;
      if (!powderId) {
        host.innerHTML = '<div class="mini">Pick a powder to see matching jobs…</div>';
        return;
      }
      host.innerHTML = '<div class="mini">Loading…</div>';
      try {
        const response = await fetch('/sprayer/hitlist.json?powder_id=' + encodeURIComponent(powderId), { cache: 'no-store' });
        if (!response.ok) throw new Error(await response.text());
        const items = await response.json();
        if (!items.length) {
          host.innerHTML = '<div class="mini">No matching on-screen jobs.</div>';
          return;
        }
        host.innerHTML = '';
        items.forEach((job) => {
          const article = document.createElement('article');
          article.className = 'job-card';
          article.innerHTML = `
            <div class="card-header">
              <div class="job-title">#${job.id} — ${job.company || ''}<span class="mini" style="margin-left:8px;">${job.color || ''}</span></div>
              <div class="mini">Due: ${job.due_by || '—'}</div>
            </div>
            <div style="margin-top:8px;"><a class="btn" href="/jobs/${job.id}">Details</a></div>`;
          host.appendChild(article);
        });
      } catch (err) {
        host.innerHTML = '<div class="mini">Failed to load.</div>';
      }
    }

    async function autofillStartWeight(powderId) {
      const input = document.querySelector('input[name="start_weight_kg"]');
      if (!powderId || !input) return;
      try {
        const response = await fetch(`/powders/${encodeURIComponent(powderId)}.json`, { cache: 'no-store' });
        if (!response.ok) return;
        const payload = await response.json();
        if (payload && payload.in_stock != null) {
          input.value = Number(payload.in_stock).toFixed(2);
        }
      } catch (err) {
        /* ignore */
      }
    }

    function bindPowderSelect() {
      const select = document.getElementById('powderSelect');
      if (!select) return;
      select.addEventListener('change', () => {
        loadCandidates(select.value);
        autofillStartWeight(select.value);
      });
    }

    document.addEventListener('DOMContentLoaded', bindPowderSelect);
  </script>
{% endblock %}

{% block content %}
<!-- Theme button automatically injected by global-theme-menu.js -->

  <header>
    <a class="btn" href="/nav">Back</a>
    <div style="font-weight:700;">Sprayer Batches</div>
    <div class="mini" style="margin-left:auto;">Log KG per batch; inventory updates on close.</div>
  </header>

  <div class="wrap">
    {% if is_admin %}
    <div class="card">
      <h2>Start new batch</h2>
      <form id="startForm" method="post" action="/sprayer/batches/start">
        <div class="row">
          <label>
            Powder
            <select id="powderSelect" name="powder_id" required>
              <option value="">Select…</option>
              {% for p in powders %}
              <option value="{{ p.id }}">
                {{ p.powder_color }}{% if p.manufacturer %} — {{ p.manufacturer }}{% endif %}{% if p.on_hand_kg is not none %} ({{ '%.2f'|format(p.on_hand_kg) }} kg){% endif %}
              </option>
              {% endfor %}
            </select>
          </label>
          <label>
            Start weight (kg)
            <input type="number" step="0.01" min="0.01" name="start_weight_kg" required placeholder="e.g., 18.60" />
          </label>
          <label>
            Operator
            <input type="text" name="operator" placeholder="Initials" />
          </label>
          <button class="btn" type="submit">Start</button>
        </div>
        <div class="mini" style="margin-top:8px;">Optional: on-screen jobs for this color</div>
        <div class="list" id="candidateList">
          <div class="mini">Pick a powder to see matching jobs…</div>
        </div>
      </form>
    </div>
    {% endif %}

    <div class="grid">
      <div class="card">
        <h2>Open Batches</h2>
        {% if not open_batches %}
          <div class="mini">None</div>
        {% else %}
          <div class="list" id="openList">
            {% for b in open_batches %}
            <article class="job-card is-collapsible" tabindex="0" aria-expanded="false">
              <div class="card-header">
                <div class="job-title">#{{ b.id }} — {{ b.powder_color }}{% if b.manufacturer %} — {{ b.manufacturer }}{% endif %}</div>
                <div class="mini">Started: {{ b.started_at }}</div>
              </div>
              <div class="details">
                <div class="mini">Start kg: {{ '%.2f'|format(b.start_weight_kg or 0) }}</div>
                {% if b.role or b.operator %}
                <div class="mini">{{ b.role or '' }}{% if b.operator %} — {{ b.operator }}{% endif %}</div>
                {% endif %}
                <div style="margin-top:8px;">
                  <a class="btn" href="/sprayer/batches/{{ b.id }}">Open</a>
                </div>
              </div>
            </article>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="card">
        <h2>Recent Batches</h2>
        {% if not recent %}
          <div class="mini">None</div>
        {% else %}
          <div class="list" id="recentList">
            {% for b in recent %}
            <article class="job-card is-collapsible" tabindex="0" aria-expanded="false">
              <div class="card-header">
                <div class="job-title">#{{ b.id }} — {{ b.powder_color }}{% if b.manufacturer %} — {{ b.manufacturer }}{% endif %}</div>
                <div class="mini">Ended: {{ b.ended_at or '—' }}</div>
              </div>
              <div class="details">
                <div class="mini">Used: {{ '%.2f'|format(b.used_kg or 0) }} kg — Duration: {{ '%.0f'|format(b.duration_min or 0) }} min</div>
                <div class="mini">Start kg: {{ '%.2f'|format(b.start_weight_kg or 0) }} — End kg: {{ '%.2f'|format(b.end_weight_kg or 0) }}</div>
                <div style="margin-top:8px;">
                  <a class="btn" href="/sprayer/batches/{{ b.id }}">View</a>
                </div>
              </div>
            </article>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      function bind(listId) {
        const list = document.getElementById(listId);
        if (!list) return;
        function toggle(card) {
          const open = card.getAttribute('aria-expanded') === 'true';
          card.setAttribute('aria-expanded', open ? 'false' : 'true');
        }
        list.addEventListener('click', (event) => {
          const target = event.target;
          if (target.closest('a,button')) return;
          const card = target.closest('.job-card');
          if (!card) return;
          toggle(card);
        });
        list.addEventListener('keydown', (event) => {
          const card = event.target.closest('.job-card');
          if (!card) return;
          const tag = (event.target.tagName || '').toUpperCase();
          if (['INPUT', 'TEXTAREA', 'SELECT', 'BUTTON', 'A'].includes(tag)) return;
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            toggle(card);
          }
        });
      }
      bind('openList');
      bind('recentList');
    })();
  </script>
{% endblock %}
