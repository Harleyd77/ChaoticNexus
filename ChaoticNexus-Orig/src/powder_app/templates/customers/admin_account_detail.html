{% extends "base.html" %}

{% block extra_head %}
  <title>{{ super() }} | {{ account.first_name }} {{ account.last_name }} · VPC Admin</title>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
  <script src="{{ url_for('static', filename='js/motion.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ui-core.js') }}"></script>
  <script src="{{ url_for('static', filename='js/global-theme-menu.js') }}"></script>
{% endblock %}

{% block content %}
  <!-- Theme menu will be injected by global-theme-menu.js -->

  <!-- Top Bar -->
  <div class="sticky top-0 z-40 bg-dark-panel/80 backdrop-blur-lg border-b border-dark-border">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <a href="/admin/customer-accounts" class="text-dark-text/60 hover:text-dark-text transition-colors">
            ← Back to Accounts
          </a>
          <h1 class="text-xl font-semibold text-dark-text">
            {{ account.first_name or '' }} {{ account.last_name or '' }}
          </h1>
          <span class="px-3 py-1 rounded-full text-sm font-medium {{ 'bg-green-900/40 text-green-300 border border-green-700/50' if account.is_active else 'bg-red-900/40 text-red-300 border border-red-700/50' }}">
            {{ 'Active' if account.is_active else 'Inactive' }}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <button id="editModeBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
            Edit Account
          </button>
          <a href="/customers" class="px-4 py-2 rounded-lg bg-dark-card hover:bg-dark-hover border border-dark-border text-sm font-medium transition-colors">
            Back to Customers
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Account Information -->
      <div class="lg:col-span-2">
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-dark-text">Account Information</h2>
            <div class="flex items-center gap-2">
              {% if account.email_verified %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900/40 text-blue-300 border border-blue-700/50">
                Email Verified
              </span>
              {% else %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900/40 text-yellow-300 border border-yellow-700/50">
                Email Unverified
              </span>
              {% endif %}
            </div>
          </div>

          <form id="accountForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-dark-text/80 mb-2">First Name</label>
                <input type="text" id="first_name" name="first_name" value="{{ account.first_name or '' }}" 
                       class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       disabled>
              </div>
              <div>
                <label class="block text-sm font-medium text-dark-text/80 mb-2">Last Name</label>
                <input type="text" id="last_name" name="last_name" value="{{ account.last_name or '' }}" 
                       class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       disabled>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">Email</label>
              <input type="email" id="email" name="email" value="{{ account.email or '' }}" 
                     class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     disabled>
            </div>

            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">Company Name</label>
              <input type="text" id="company_name" name="company_name" value="{{ account.company_name or '' }}" 
                     class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     disabled>
            </div>

            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">Phone</label>
              <input type="tel" id="phone" name="phone" value="{{ account.phone or '' }}" 
                     class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     disabled>
            </div>

            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">Address</label>
              <textarea id="address" name="address" rows="3" 
                        class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        disabled>{{ account.address or '' }}</textarea>
            </div>

            <div class="flex items-center gap-4">
              <label class="flex items-center">
                <input type="checkbox" id="is_active" name="is_active" {{ 'checked' if account.is_active else '' }} 
                       class="rounded border-dark-border bg-dark-panel text-blue-600 focus:ring-blue-500" 
                       disabled>
                <span class="ml-2 text-sm text-dark-text/80">Account Active</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="email_verified" name="email_verified" {{ 'checked' if account.email_verified else '' }} 
                       class="rounded border-dark-border bg-dark-panel text-blue-600 focus:ring-blue-500" 
                       disabled>
                <span class="ml-2 text-sm text-dark-text/80">Email Verified</span>
              </label>
            </div>

            <div class="flex items-center gap-4 pt-4">
              <button type="submit" id="saveBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors" style="display: none;">
                Save Changes
              </button>
              <button type="button" id="cancelBtn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors" style="display: none;">
                Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- Password Management -->
        <div class="bg-dark-card rounded-xl border border-dark-border p-6 mt-6">
          <h2 class="text-lg font-semibold text-dark-text mb-4">Password Management</h2>
          
          <form id="passwordForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">New Password</label>
              <input type="password" id="new_password" name="password" 
                     class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     placeholder="Enter new password">
              <p class="text-xs text-dark-text/60 mt-1">
                Password must be at least 8 characters with uppercase letter and number
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium text-dark-text/80 mb-2">Confirm Password</label>
              <input type="password" id="confirm_password" name="confirm_password" 
                     class="w-full px-3 py-2 rounded-lg bg-dark-panel border border-dark-border text-dark-text focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     placeholder="Confirm new password">
            </div>
            <button type="submit" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
              Reset Password
            </button>
          </form>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Account Stats -->
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
          <h3 class="text-lg font-semibold text-dark-text mb-4">Account Stats</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-dark-text/60">Account ID:</span>
              <span class="text-dark-text font-mono">{{ account.id }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-dark-text/60">Created:</span>
              <span class="text-dark-text">{{ account.created_at.strftime('%Y-%m-%d') if account.created_at else 'Unknown' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-dark-text/60">Last Login:</span>
              <span class="text-dark-text">{{ account.last_login.strftime('%Y-%m-%d') if account.last_login else 'Never' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-dark-text/60">Last Updated:</span>
              <span class="text-dark-text">{{ account.updated_at.strftime('%Y-%m-%d') if account.updated_at else 'Unknown' }}</span>
            </div>
          </div>
        </div>

        <!-- Associated Customer Record -->
        {% if account.customer_id %}
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
          <h3 class="text-lg font-semibold text-dark-text mb-4">Customer Record</h3>
          <div class="space-y-2">
            <div class="text-sm">
              <span class="text-dark-text/60">Company:</span>
              <span class="text-dark-text">{{ account.company or 'N/A' }}</span>
            </div>
            <div class="text-sm">
              <span class="text-dark-text/60">Contact:</span>
              <span class="text-dark-text">{{ account.contact_name or 'N/A' }}</span>
            </div>
            <div class="text-sm">
              <span class="text-dark-text/60">Phone:</span>
              <span class="text-dark-text">{{ account.customer_phone or 'N/A' }}</span>
            </div>
            <div class="text-sm">
              <span class="text-dark-text/60">Email:</span>
              <span class="text-dark-text">{{ account.customer_email or 'N/A' }}</span>
            </div>
          </div>
          <div class="mt-4">
            <a href="/customers/{{ account.customer_id }}" class="text-blue-400 hover:text-blue-300 text-sm transition-colors">
              View Customer Profile →
            </a>
          </div>
        </div>
        {% endif %}

        <!-- Recent Jobs -->
        {% if jobs %}
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
          <h3 class="text-lg font-semibold text-dark-text mb-4">Recent Jobs</h3>
          <div class="space-y-3">
            {% for job in jobs[:5] %}
            <div class="border-l-2 border-blue-500 pl-3">
              <div class="text-sm font-medium text-dark-text">Job #{{ job.id }}</div>
              <div class="text-xs text-dark-text/60">{{ job.type or 'Unknown Type' }}</div>
              <div class="text-xs text-dark-text/60">{{ job.created_at[:10] if job.created_at|length > 10 else job.created_at }}</div>
            </div>
            {% endfor %}
          </div>
          {% if jobs|length > 5 %}
          <div class="mt-4">
            <a href="/customers/{{ account.customer_id }}" class="text-blue-400 hover:text-blue-300 text-sm transition-colors">
              View All Jobs →
            </a>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="fixed top-4 right-4 z-50"></div>

  <script>
    let isEditMode = false;

    // Edit mode toggle
    document.getElementById('editModeBtn').addEventListener('click', function() {
      if (!isEditMode) {
        enableEditMode();
      } else {
        disableEditMode();
      }
    });

    function enableEditMode() {
      isEditMode = true;
      document.getElementById('editModeBtn').textContent = 'Cancel Edit';
      document.getElementById('editModeBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
      document.getElementById('editModeBtn').classList.add('bg-gray-600', 'hover:bg-gray-700');
      
      // Enable form fields
      const fields = ['first_name', 'last_name', 'email', 'company_name', 'phone', 'address', 'is_active', 'email_verified'];
      fields.forEach(field => {
        const element = document.getElementById(field);
        element.disabled = false;
        element.classList.remove('bg-dark-panel');
        element.classList.add('bg-dark-card');
      });
      
      // Show save/cancel buttons
      document.getElementById('saveBtn').style.display = 'inline-block';
      document.getElementById('cancelBtn').style.display = 'inline-block';
    }

    function disableEditMode() {
      isEditMode = false;
      document.getElementById('editModeBtn').textContent = 'Edit Account';
      document.getElementById('editModeBtn').classList.remove('bg-gray-600', 'hover:bg-gray-700');
      document.getElementById('editModeBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
      
      // Disable form fields
      const fields = ['first_name', 'last_name', 'email', 'company_name', 'phone', 'address', 'is_active', 'email_verified'];
      fields.forEach(field => {
        const element = document.getElementById(field);
        element.disabled = true;
        element.classList.add('bg-dark-panel');
        element.classList.remove('bg-dark-card');
      });
      
      // Hide save/cancel buttons
      document.getElementById('saveBtn').style.display = 'none';
      document.getElementById('cancelBtn').style.display = 'none';
    }

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
      // Reload page to reset form
      window.location.reload();
    });

    // Account form submission
    document.getElementById('accountForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {};
      
      // Collect form data
      for (let [key, value] of formData.entries()) {
        if (key === 'is_active' || key === 'email_verified') {
          data[key] = document.getElementById(key).checked;
        } else {
          data[key] = value;
        }
      }
      
      try {
        const response = await fetch(`/api/admin/customer-accounts/{{ account.id }}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showToast('Account updated successfully', 'success');
          disableEditMode();
          // Reload page to show updated data
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || 'Failed to update account', 'error');
        }
      } catch (error) {
        showToast('Network error occurred', 'error');
      }
    });

    // Password form submission
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const password = document.getElementById('new_password').value;
      const confirmPassword = document.getElementById('confirm_password').value;
      
      if (password !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 8) {
        showToast('Password must be at least 8 characters long', 'error');
        return;
      }
      
      if (!/[A-Z]/.test(password)) {
        showToast('Password must contain at least one uppercase letter', 'error');
        return;
      }
      
      if (!/\d/.test(password)) {
        showToast('Password must contain at least one number', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/customer-accounts/{{ account.id }}/password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ password: password })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showToast(result.message, 'success');
          // Clear form
          document.getElementById('passwordForm').reset();
        } else {
          showToast(result.error || 'Failed to update password', 'error');
        }
      } catch (error) {
        showToast('Network error occurred', 'error');
      }
    });

    // Toast notification system
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastElement = document.createElement('div');
      
      const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
      
      toastElement.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2 transition-all duration-300 transform translate-x-full`;
      toastElement.textContent = message;
      
      toast.appendChild(toastElement);
      
      // Animate in
      setTimeout(() => {
        toastElement.classList.remove('translate-x-full');
      }, 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toastElement.classList.add('translate-x-full');
        setTimeout(() => {
          if (toastElement.parentNode) {
            toastElement.parentNode.removeChild(toastElement);
          }
        }, 300);
      }, 5000);
    }
  </script>
{% endblock %}
