{% extends "customer_portal/base.html" %}

{% block title %}Job #{{ job.id }} Details{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('customer_portal.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('customer_portal.jobs_list') }}">My Jobs</a></li>
        <li class="breadcrumb-item active">Job #{{ job.id }}</li>
      </ol>
    </nav>
  </div>
</div>

<div class="row mb-4">
  <div class="col">
    <div class="card bg-secondary">
      <div class="card-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
          <h2 class="card-title mb-0">Job #{{ job.id }}</h2>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="badge fs-6
              {% if job.status == 'Completed' %}bg-success
              {% elif job.status == 'Ready for Pickup' %}bg-info
              {% elif job.status == 'In Progress' %}bg-warning
              {% elif job.status == 'Not Started' %}bg-secondary
              {% elif job.status == 'Pending Approval' %}bg-primary
              {% else %}bg-light text-dark{% endif %}">
              {{ job.status }}
            </span>
            {% if job.status in ['Pending Approval', 'Not Started'] %}
            <a href="{{ url_for('customer_portal.edit_job', job_id=job.id) }}"
               class="btn btn-warning btn-sm">Edit Job</a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h5>Job Details</h5>
            <dl class="row">
              <dt class="col-sm-4">Description:</dt>
              <dd class="col-sm-8">{{ job.description or 'No description provided' }}</dd>

              <dt class="col-sm-4">Type:</dt>
              <dd class="col-sm-8">{{ job.type or 'Not specified' }}</dd>

              <dt class="col-sm-4">Priority:</dt>
              <dd class="col-sm-8">{{ job.priority or 'Normal' }}</dd>

              <dt class="col-sm-4">Submitted:</dt>
              <dd class="col-sm-8">{{ job.created_at[:10] if job.created_at else 'N/A' }}</dd>

              <dt class="col-sm-4">Due Date:</dt>
              <dd class="col-sm-8">{{ job.due_by if job.due_by else 'No due date' }}</dd>

              <dt class="col-sm-4">Contact:</dt>
              <dd class="col-sm-8">
                {{ job.contact_name or 'N/A' }}
                {% if job.company %}<br><small class="text-muted">{{ job.company }}</small>{% endif %}
              </dd>

              <dt class="col-sm-4">Phone:</dt>
              <dd class="col-sm-8">{{ job.phone or 'N/A' }}</dd>

              <dt class="col-sm-4">Email:</dt>
              <dd class="col-sm-8">{{ job.email or 'N/A' }}</dd>

              <dt class="col-sm-4">PO Number:</dt>
              <dd class="col-sm-8">{{ job.po or 'N/A' }}</dd>
            </dl>

            {% if job.blast or job.prep or job.color %}
            <h6 class="mt-4">Technical Details</h6>
            <dl class="row">
              {% if job.blast %}
              <dt class="col-sm-4">Blasting:</dt>
              <dd class="col-sm-8">{{ job.blast }}</dd>
              {% endif %}

              {% if job.prep %}
              <dt class="col-sm-4">Preparation:</dt>
              <dd class="col-sm-8">{{ job.prep }}</dd>
              {% endif %}

              {% if job.color %}
              <dt class="col-sm-4">Color/Finish:</dt>
              <dd class="col-sm-8">{{ job.color }}</dd>
              {% endif %}
            </dl>
            {% endif %}

            {% if job.notes %}
            <h6 class="mt-4">Additional Notes</h6>
            <p class="text-muted">{{ job.notes }}</p>
            {% endif %}
          </div>

          <div class="col-md-4">
            <h5>Progress Updates</h5>
            {% if edit_history %}
              <div class="timeline">
                {% for edit in edit_history[:5] %}
                <div class="timeline-item">
                  <div class="timeline-marker
                    {% if edit.changed_by_customer %}bg-primary
                    {% else %}bg-info{% endif %}"></div>
                  <div class="timeline-content">
                    <small class="text-muted">{{ edit.created_at[:10] if edit.created_at else 'N/A' }}</small>
                    <p class="mb-1">
                      <strong>{{ edit.field_name|title }}</strong> changed
                      {% if edit.changed_by_customer %}by you{% else %}by shop{% endif %}
                    </p>
                    {% if edit.change_reason %}
                    <small class="text-muted">Reason: {{ edit.change_reason }}</small>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if edit_history|length > 5 %}
              <p class="text-center mt-2">
                <a href="#edit-history" data-bs-toggle="collapse" class="text-decoration-none">
                  View full history ({{ edit_history|length }} changes)
                </a>
              </p>
              {% endif %}
            {% else %}
              <p class="text-muted">No changes recorded yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Full Edit History (Collapsible) -->
{% if edit_history|length > 5 %}
<div class="row">
  <div class="col">
    <div class="card bg-secondary">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <a href="#edit-history" data-bs-toggle="collapse" class="text-decoration-none">
            Complete Edit History
          </a>
        </h5>
      </div>
      <div id="edit-history" class="collapse">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-dark table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Field</th>
                  <th>Changed By</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                {% for edit in edit_history %}
                <tr>
                  <td>{{ edit.created_at[:10] if edit.created_at else 'N/A' }}</td>
                  <td>{{ edit.field_name|title }}</td>
                  <td>
                    <span class="badge
                      {% if edit.changed_by_customer %}bg-primary
                      {% else %}bg-info{% endif %}">
                      {{ 'Customer' if edit.changed_by_customer else 'Shop' }}
                    </span>
                  </td>
                  <td>{{ edit.change_reason or '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<style>
.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #495057;
}

.timeline-item {
  position: relative;
  margin-bottom: 20px;
}

.timeline-marker {
  position: absolute;
  left: -23px;
  top: 5px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #495057;
}

.timeline-content {
  background: #343a40;
  padding: 10px 15px;
  border-radius: 8px;
  border-left: 3px solid #0d6efd;
}
</style>
{% endblock %}
